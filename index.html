<!DOCTYPE html>
<html lang=en-au>
<head>
    <meta charset=utf-8 />
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>Inner Melbourne Football League</title>
    <style>
      body {
          margin-left: 50px; 
          font-variant-numeric: lining-nums;
          font-family: Corbel, "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "DejaVu Sans", "Bitstream Vera Sans", "Liberation Sans", Verdana, "Verdana Ref", sans-serif;
      }
      th {text-align:center; padding-right:6px; padding-left:6px}
      td { text-align:right; padding-right:6px; padding-left:6px}
      td.name { text-align:left}
      tr.borderBottom td {border-bottom: 1px solid black}
      tr:nth-child(even) {background-color: #eeeeee}
      label {margin-left: 20px;}  
      #seasonDetails {margin-bottom: 150px;}
}
    </style>
</head>
<body>
    <h1>Inner Melbourne Football League</h1>
    <label for="yearSelect">Season: </label> <select id="yearSelect"></select><label for=south>South Melbourne</label><input type=checkbox id=south checked /><label for=fitzroy>Fitzroy</label><input type=checkbox id=fitzroy checked />
    <div id="seasonDetails"></div>
    <script>
        var seasons = {};
        var teams = ["Carlton", "Collingwood", "Essendon", "Fitzroy", "Footscray", "Geelong", "Hawthorn", "Melbourne", "North Melbourne", "Richmond", "South Melbourne", "St Kilda"];

        document.body.onload = function ()
        {
            // use ajax to get text file
            var request = new XMLHttpRequest();
            request.open("GET", "imfl.csv.txt");
            request.onreadystatechange = function ()
            {
                if (request.readyState == 4 && request.status == 200)
                {
                    loadSeasons(request.responseText);
                    document.getElementById("yearSelect").onchange = loadSeason;
                    document.getElementById("yearSelect").selectedIndex = 0;
                    loadSeason();
                }
            }
            request.send(null);
        };


        function loadSeason()
        {
            var select = document.getElementById("yearSelect");
            var season = select.options[select.selectedIndex].value;
            var seasonData = seasons[season];
            var ladder = {};
            var ladderDone = false;

            var div = document.getElementById("seasonDetails");
            div.innerHTML = "";
            
            var includeSouth = document.getElementById("south").checked;
            var includeFitzroy = document.getElementById("fitzroy").checked;

            for (var round in seasonData)
            {
                if (round.indexOf("F") >= 0 && !ladderDone)
                {
                    div.innerHTML += doLadder(ladder);
                    ladderDone = true;
                }

                div.innerHTML += "<h2>" + round + "</h2>";
                for (var i = 0; i < seasonData[round].length; ++i)
                {
                    var match = seasonData[round][i];
                    
                    if (!includeSouth && (match.homeTeam == "South Melbourne" || match.awayTeam == "South Melbourne"))
                      continue;
                    if (!includeFitzroy && (match.homeTeam == "Fitzroy" || match.awayTeam == "Fitzroy"))
                      continue;
                    
                    var homeTeamPoints = parseInt((match.homeGoals * 6) + match.homeBehinds);
                    var awayTeamPoints = parseInt((match.awayGoals * 6) + match.awayBehinds);

                    div.innerHTML += "<span>";
                    if (homeTeamPoints >= awayTeamPoints)
                        div.innerHTML += "<strong>" + match.homeTeam + " " + match.homeGoals + "." + match.homeBehinds + "." + homeTeamPoints + "</strong>";
                    else
                        div.innerHTML += match.homeTeam + " " + match.homeGoals + "." + match.homeBehinds + "." + homeTeamPoints;

                    div.innerHTML += " vs ";

                    if (homeTeamPoints <= awayTeamPoints)
                        div.innerHTML += "<strong>" + match.awayTeam + " " + match.awayGoals + "." + match.awayBehinds + "." + awayTeamPoints + "</strong>";
                    else
                        div.innerHTML += match.awayTeam + " " + match.awayGoals + "." + match.awayBehinds + "." + awayTeamPoints;

                    div.innerHTML += "<br>"

                    // now add result to ladder
                    if (!ladder[match.homeTeam])
                        ladder[match.homeTeam] = { wins: 0, losses: 0, draws: 0, pfor: 0, against: 0, points: 0, percentage: 0 };
                    if (!ladder[match.awayTeam])
                        ladder[match.awayTeam] = { wins: 0, losses: 0, draws: 0, pfor: 0, against: 0, points: 0, percentage: 0 };

                    if (homeTeamPoints > awayTeamPoints)
                    {
                        ladder[match.homeTeam].wins += 1;
                        ladder[match.homeTeam].points += 4
                        ladder[match.awayTeam].losses += 1;
                    }
                    else if (homeTeamPoints == awayTeamPoints)
                    {
                        ladder[match.homeTeam].draws += 1;
                        ladder[match.homeTeam].points += 2
                        ladder[match.awayTeam].draws += 1;
                        ladder[match.awayTeam].points += 2
                    }
                    else if (homeTeamPoints < awayTeamPoints)
                    {
                        ladder[match.homeTeam].losses += 1;
                        ladder[match.awayTeam].wins += 1;
                        ladder[match.awayTeam].points += 4
                    }
                    ladder[match.homeTeam].pfor += homeTeamPoints;
                    ladder[match.homeTeam].against += awayTeamPoints;
                    ladder[match.awayTeam].pfor += awayTeamPoints;
                    ladder[match.awayTeam].against += homeTeamPoints;
                    ladder[match.homeTeam].percentage = ladder[match.homeTeam].pfor / ladder[match.homeTeam].against * 100;
                    ladder[match.awayTeam].percentage = ladder[match.awayTeam].pfor / ladder[match.awayTeam].against * 100;

                }
            }
            if (!ladderDone)
              div.innerHTML += doLadder(ladder);
        }

        function doLadder(ladder)
        {
            var ret = "<h2>Ladder</h2>";
            // sort teams
            var sortedLadder = [];
            for (var team in ladder)
            {
                sortedLadder.push({ name: team, data: ladder[team] });
            }
            sortedLadder.sort(sorter);

            // write ladder
            ret += "<table><tr><th></th><th>W</th><th>L</th><th>D</th><th>F</th><th>A</th><th>%</th><th>Pts</th></tr>";
            for (var i = 0; i < sortedLadder.length; ++i)
            {
                var team = sortedLadder[i];
                var tr = "<tr>";
                if (i == 4)
                    tr = "<tr class=borderBottom>"

                ret += tr + "<td class=name>" + team.name + "</td><td>" + team.data.wins + "</td><td>" + team.data.losses + "</td><td>" + team.data.draws + "</td><td>" + team.data.pfor + "</td><td>" + team.data.against + "</td><td>" + team.data.percentage.toFixed(1) + "</td><td>" + team.data.points + "</td></tr>";
            }
            ret += "</table>";
            return ret;
        }


        function sorter(a, b)
        {
            if (a.data.points < b.data.points)
                return 1;
            if (a.data.points > b.data.points)
                return -1;
            if (a.data.points == b.data.points)
            {
                if (a.data.percentage < b.data.percentage)
                    return 1;
                if (a.data.percentage > b.data.percentage)
                    return -1;
            }
            return 0;
        }

        function loadSeasons(text)
        {
            var seasonData = text.split("\n");
            var i;
            for (i = 0; i < seasonData.length; ++i)
            {
                if (!seasonData[i])
                  break;
                var matchData = seasonData[i].split(",");
                var year = matchData[0];
                var roundNumber = matchData[1];
                var homeTeam = verifyTeam(matchData[2]);
                var homeGoals = matchData[3];
                var homeBehinds = matchData[4];
                var awayTeam = matchData[5];
                var awayGoals = matchData[6];
                var awayBehinds = matchData[7];

                // create the season if it doesn't exist
                if (!seasons[year])
                {
                    seasons[year] = {};
                    document.getElementById("yearSelect").add(new Option(year, year), 0);
                }
                var season = seasons[year];
                // create the round if it doesn't exist
                if (!season[roundNumber])
                    season[roundNumber] = [];
                var round = season[roundNumber];
                // add the match
                round.push({
                    homeTeam: homeTeam,
                    homeGoals: parseInt(homeGoals),
                    homeBehinds: parseInt(homeBehinds),
                    awayTeam: awayTeam,
                    awayGoals: parseInt(awayGoals),
                    awayBehinds: parseInt(awayBehinds)
                });
            }
        }

        function verifyTeam(teamName)
        {
            for (var i = 0; i < teams.length; ++i)
                if (teams[i] == teamName)
                    return teamName;

            throw new Error("incorrect team Name found: " + teamName);
        }
        
        document.getElementById("south").onchange = function() {
          loadSeason();
        };
        document.getElementById("fitzroy").onchange = function() {
          loadSeason();
        };


    </script>
</body>
</html>
