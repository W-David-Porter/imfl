<!DOCTYPE html>
<html lang=en-au>
<head>
	<meta charset=utf-8 />
	<meta name=viewport content="width=device-width, initial-scale=1">
	<link rel=prefetch href=https://unpkg.com/vue>
	<link rel=prefetch href=https://unpkg.com/papaparse>
	<link rel=prefetch href=https://imfl.neocities.org/yeardata/2019.csv>
	<title>Inner Melbourne Football League</title>
	<style>
		body {
			margin-left: 5em; 
			font-variant-numeric: lining-nums;
			font-family: Corbel, "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "DejaVu Sans", "Bitstream Vera Sans", "Liberation Sans", Verdana, "Verdana Ref", sans-serif;
		}
		label {margin-left: 2em;}  
		#roundsDiv {margin-bottom: 4em;}
		#ladderDiv {margin-bottom: 4em;}
		#finalsDiv {margin-bottom: 4em;}
		thead tr th {text-align:center; padding-right:.5em; padding-left:.5em}
		tr th {text-align:left; padding-right:.5em; font-weight: normal}
		td { text-align:right; padding-right:.5em; padding-left:.5em}
		tr:nth-child(even) {background-color: #eeeeee}
		tr:nth-child(5) > th, tr:nth-child(5) > td {border-bottom: 1px black solid}

		</style>
</head>
<body>
	<h1>Inner Melbourne Football League</h1>
	<label for=yearSelect>Season: </label> 
	<select id=yearSelect><option v-for="(year, index) in years" v-bind:selected="year == currentYear" v-text="year"></option></select> 
	<label for=south>South Melbourne</label> 
	<input type=checkbox id=south /> 
	<label for=fitz>Fitzroy</label> 
	<input type=checkbox id=fitz />

	<div id="roundsDiv">
		<div class=round v-for="round in filteredRounds()">
			<h2>{{round.name}}</h2>
			<span v-for="match in round.matches">
				<span v-bind:style="{fontWeight: match.homeWin}">{{match.homeTeam}} {{match.homeGoals}}.{{match.homeBehinds}}.{{match.homePoints}}</span> vs <span  v-bind:style="{fontWeight: match.awayWin}">{{match.awayTeam}} {{match.awayGoals}}.{{match.awayBehinds}}.{{match.awayPoints}}</span><br>
			</span>
		</div>
	</div>


	<h2>Ladder</h2>
	<table id=ladderTable>
		<thead>
			<tr>
				<th></th><th>W</th><th>L</th><th>D</th><th>F</th><th>A</th><th>%</th><th>Pts</th>
			</tr>
		</thead>
		<tbody>
			<tr v-for="(team, index) in filteredLadder()">
				<th>{{team.name}}</th><td>{{team.wins}}</td><td>{{team.losses}}</td><td>{{team.draws}}</td><td>{{team.for}}</td><td>{{team.against}}</td><td>{{team.percentage.toFixed(2)}}</td><td>{{team.points}}</td>
			</tr>
		</tbody>
	</table>


	<div id="finalsDiv">
		<div class=round v-for="final in filteredFinals()">
			<h2 v-if="final.matches.length > 0">{{final.name}}</h2>
			<span v-for="match in final.matches">
				<span v-bind:style="{fontWeight: match.homeWin}">{{match.homeTeam}} {{match.homeGoals}}.{{match.homeBehinds}}.{{match.homePoints}}</span> vs <span  v-bind:style="{fontWeight: match.awayWin}">{{match.awayTeam}} {{match.awayGoals}}.{{match.awayBehinds}}.{{match.awayPoints}}</span><br>
			</span>
		</div>
	</div>


	<script src="https://unpkg.com/vue"></script>
	<script src="https://unpkg.com/papaparse"></script>
	<script>
		imfl = { 
			roundsVue: null,
			years: {}
		};


var buildLadder = function(rounds) {
	console.log("buildLadder", rounds);

	var teams = {};
	var ladder = [];

	Object.keys(rounds).forEach(function(roundName) {
		var round = rounds[roundName];
		round.matches.forEach(function(match) {
			if (!teams[match.homeTeam])
				teams[match.homeTeam] = { wins: 0, losses: 0, draws: 0, for: 0, against: 0 };
			if (!teams[match.awayTeam])
				teams[match.awayTeam] = { wins: 0, losses: 0, draws: 0, for: 0, against: 0 };

			if (match.homePoints > match.awayPoints) {
				teams[match.homeTeam].wins++;
				teams[match.awayTeam].losses++;
			}
			else if (match.homePoints < match.awayPoints) {
				teams[match.awayTeam].wins++;
				teams[match.homeTeam].losses++;
			}
			else {
				teams[match.homeTeam].draws++;
				teams[match.awayTeam].draws++;
			}

			teams[match.homeTeam].for += match.homePoints;
			teams[match.homeTeam].against += match.awayPoints;
			teams[match.awayTeam].for += match.awayPoints;
			teams[match.awayTeam].against += match.homePoints;

		});
	});
	
	// convert to array
	Object.keys(teams).forEach(function(key) {
		var team = teams[key];
		
		// fill in the rest of the details
		team.name = key;
		team.points = (team.wins * 4) + (team.draws * 2);
		team.percentage = team.for / team.against * 100.0;
		ladder.push(team);
	});

	ladder.sort(function(a, b) {
		if (a.points > b.points)
			return -1;
		if (a.points < b.points)
			return 1;
		// else go by percentage
		if (a.percentage > b.percentage)
			return -1;
		if (a.percentage < b.percentage)
			return 1;
		return 0;
	});

	imfl.years[imfl.currentYear].ladder = ladder;
}


var loadSeason = function(results) {
	console.log("loadSeason", results);
	if (!imfl.years[imfl.currentYear]) {
		imfl.years[imfl.currentYear] = {
			rounds: {},
			ladder: [],
			finals: {}
		};

		results.data.forEach(function(d) {

			var match = {
				homeTeam: d.homeTeam,
				homeGoals: d.homeGoals,
				homeBehinds: d.homeBehinds,
				homePoints: (d.homeGoals * 6) + d.homeBehinds,
				homeWin: "normal",
				awayTeam: d.awayTeam,
				awayGoals: d.awayGoals,
				awayBehinds: d.awayBehinds,
				awayPoints: (d.awayGoals * 6) + d.awayBehinds,
				awayWin: "normal"
			};

			if (match.homePoints > match.awayPoints)
				match.homeWin = "bold";
			else if (match.homePoints < match.awayPoints)
				match.awayWin = "bold";

			if (d.round.indexOf("Finals") == 0) {
				if (!imfl.years[imfl.currentYear].finals[d.round]) {
					imfl.years[imfl.currentYear].finals[d.round] = { 
						name: d.round, 
						matches: [],
					};
				}
				imfl.years[imfl.currentYear].finals[d.round].matches.push(match);
			}
			else {
				if (!imfl.years[imfl.currentYear].rounds[d.round]) {
					imfl.years[imfl.currentYear].rounds[d.round] = { 
						name: d.round, 
						matches: [],
					};
				}
				imfl.years[imfl.currentYear].rounds[d.round].matches.push(match);

			}

		});

		buildLadder(imfl.years[imfl.currentYear].rounds);
	}

	console.log(imfl.currentYear, "rounds", imfl.years[imfl.currentYear].rounds);
	console.log(imfl.currentYear, "finals", imfl.years[imfl.currentYear].finals);
	console.log(imfl.currentYear, "ladder", imfl.years[imfl.currentYear].ladder);

	if (imfl.roundsVue) {
		imfl.roundsVue.rounds = imfl.years[imfl.currentYear].rounds;
	}	else {
		imfl.roundsVue = new Vue({
			el: "#roundsDiv",
			data: {rounds: imfl.years[imfl.currentYear].rounds},
			methods: { 
				filteredRounds: function() {
					var newRounds = {};
					var myRounds = this.rounds;
					Object.keys(this.rounds).forEach(function(key) {
						newRounds[key] = { 
							name: myRounds[key].name, 
							matches: myRounds[key].matches.filter(function(m) {
							if(!imfl.fitz) {
								if (m.homeTeam == "Fitzroy" || m.awayTeam == "Fitzroy")
									return false;
							}
							if(!imfl.south) {
								if (m.homeTeam == "South Melbourne" || m.awayTeam == "South Melbourne")
									return false;
							}
							return true;
						})
						} 
					});
					return newRounds;
				}
			}
		});
	}

	if (imfl.finalsVue) {
		imfl.finalsVue.rounds = imfl.years[imfl.currentYear].rounds;
	}	else {
		imfl.finalsVue = new Vue({
			el: "#finalsDiv",
			data: {finals: imfl.years[imfl.currentYear].finals},
			methods: { 
				filteredFinals: function() {
					var newFinals = {};
					var myFinals = this.finals;
					Object.keys(this.finals).forEach(function(key) {
						newFinals[key] = { 
							name: myFinals[key].name, 
							matches: myFinals[key].matches.filter(function(m) {
							if(!imfl.fitz) {
								if (m.homeTeam == "Fitzroy" || m.awayTeam == "Fitzroy")
									return false;
							}
							if(!imfl.south) {
								if (m.homeTeam == "South Melbourne" || m.awayTeam == "South Melbourne")
									return false;
							}
							return true;
						})
						} 
					});
					return newFinals;
				}
			}
		});
	}

	if (imfl.ladderVue) {
	imfl.ladderVue.ladder = imfl.years[imfl.currentYear].ladder;
}	else {
	imfl.ladderVue = new Vue({
		el: "#ladderTable",
		data: {ladder: imfl.years[imfl.currentYear].ladder},
		methods: { 
			filteredLadder: function() {
				buildLadder(imfl.roundsVue.filteredRounds());
				return imfl.years[imfl.currentYear].ladder;
			}
		}
	});
}

};

var fetchData = function() {
	console.log("now in: fetchData");
	console.log("selected year:", imfl.currentYear);

	if (imfl.years[imfl.currentYear]) {
		loadSeason();
	}

	var urlBase = "https://imfl.neocities.org/yeardata/";
	
	Papa.parse(urlBase + imfl.currentYear + ".csv", {
		download: true,
		header: true,
		dynamicTyping: true,
		skipEmptyLines: true,
		complete: function(results) {
			loadSeason(results);
		},
		error: function() {
			console.log("assume the season hasn't started for this year yet. Maybe one day I'll put a fixture");
			yearSelect.options.remove(0);
			imfl.currentYear = document.getElementById("yearSelect").value;
			window.location.hash = imfl.currentYear;
			Papa.parse(urlBase + imfl.currentYear + ".csv", {
				download: true,
				header: true,
				dynamicTyping: true,
				skipEmptyLines: true,
				complete: function(results) {
					loadSeason(results);
				},
				error: function() {
					console.log("second error, bailing out");
				}
			});
		}
	});

};


var onTraitorChange = function() {
	console.log("onTraitorChange", this.id, this.checked);
	imfl[this.id] = this.checked;
	localStorage.setItem(this.id, this.checked ? "checked" : "");
	imfl.roundsVue.$forceUpdate();
	imfl.finalsVue.$forceUpdate();
	imfl.ladderVue.$forceUpdate();
}

// start here

// first we use local storage to see if we want fitz and south
var traitors = ["fitz", "south"];
traitors.forEach(function(team) {
	var ls = localStorage.getItem(team);
	if (ls != null) {
			document.getElementById(team).checked = imfl[team] = (ls == "checked");
	} 
	else {
		localStorage.setItem(team, "checked"); // set a default value
		imfl[team] = true;
	}
});

document.getElementById("fitz").addEventListener("change", onTraitorChange);
document.getElementById("south").addEventListener("change", onTraitorChange);

// second populate the year select box
imfl.currentYear = new Date().getFullYear();
var years = [];
for(var i = imfl.currentYear; i >= 1982; --i)
	years.push(String(i));
var hashYear = window.location.hash;
if (hashYear) {
	hashYear = hashYear.substring(1);
	if (years.indexOf(hashYear) >= 0) {
		imfl.currentYear = hashYear;
	} 
	else {
		imfl.currentYear = new Date().getFullYear();
		window.location.hash = imfl.currentYear;
	}
} 
var yearsVue = new Vue({
	el: "#yearSelect",
	data: {
		years: years,
		currentYear: imfl.currentYear
	},
	mounted: fetchData
});

document.getElementById("yearSelect").addEventListener("change", function() {
	imfl.currentYear = this.value;
	window.location.hash = imfl.currentYear;
	fetchData();
});




</script>
</body>
</html>
