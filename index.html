<!DOCTYPE html>
<html lang=en-au>
<head>
	<meta charset=utf-8 />
	<meta name=viewport content="width=device-width, initial-scale=1">
	<title>Inner Melbourne Football League</title>
	<style>
		body {
			margin-left: 5em; 
			font-variant-numeric: lining-nums;
			font-family: Corbel, "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "DejaVu Sans", "Bitstream Vera Sans", "Liberation Sans", Verdana, "Verdana Ref", sans-serif;
		}
		label {margin-left: 2em;}  
		#roundsDiv {margin-bottom: 8em;}
		th {text-align:center; padding-right:6px; padding-left:6px}
		td { text-align:right; padding-right:6px; padding-left:6px}
		td.name { text-align:left}
		tr.borderBottom td {border-bottom: 1px solid black}
		tr:nth-child(even) {background-color: #eeeeee}

		</style>
</head>
<body>
	<h1>Inner Melbourne Football League</h1>
	<label for=yearSelect>Season: </label> 
	<select id=yearSelect><option v-for="(year, index) in years" v-bind:selected="year == currentYear" v-text="year"></option></select> 
	<label for=south>South Melbourne</label> 
	<input type=checkbox id=south checked /> 
	<label for=fitz>Fitzroy</label> 
	<input type=checkbox id=fitz checked />

	<div id="roundsDiv">
		<div class=round v-for="round in filteredRounds()">
			<h2>{{round.name}}</h2>
			<span v-for="match in round.matches">
				<span v-bind:style="{fontWeight: match.homeWin}">{{match.homeTeam}} {{match.homeGoals}}.{{match.homeBehinds}}.{{match.homePoints}}</span> vs <span  v-bind:style="{fontWeight: match.awayWin}">{{match.awayTeam}} {{match.awayGoals}}.{{match.awayBehinds}}.{{match.awayPoints}}</span><br>
			</span>
		</div>
	</div>

	<div id="finalsDiv">
		<div class=round v-for="final in filteredFinals()">
			<h2>{{final.name}}</h2>
			<span v-for="match in final.matches">
				<span v-bind:style="{fontWeight: match.homeWin}">{{match.homeTeam}} {{match.homeGoals}}.{{match.homeBehinds}}.{{match.homePoints}}</span> vs <span  v-bind:style="{fontWeight: match.awayWin}">{{match.awayTeam}} {{match.awayGoals}}.{{match.awayBehinds}}.{{match.awayPoints}}</span><br>
			</span>
		</div>
	</div>


	<script src="https://unpkg.com/vue"></script>
	<script src="https://unpkg.com/papaparse"></script>
	<script>
		imfl = { 
			roundsVue: null,
			years: {}
		};


var loadSeason = function(results) {
	console.log("loadSeason", results);
	if (!imfl.years[imfl.currentYear]) {
		imfl.years[imfl.currentYear] = {
			rounds: {},
			ladder: {},
			finals: {}
		};

		results.data.forEach(function(d) {

			var match = {
				homeTeam: d.homeTeam,
				homeGoals: d.homeGoals,
				homeBehinds: d.homeBehinds,
				homePoints: (d.homeGoals * 6) + d.homeBehinds,
				homeWin: "normal",
				awayTeam: d.awayTeam,
				awayGoals: d.awayGoals,
				awayBehinds: d.awayBehinds,
				awayPoints: (d.awayGoals * 6) + d.awayBehinds,
				awayWin: "normal"
			};

			if (match.homePoints > match.awayPoints)
				match.homeWin = "bold";
			else if (match.homePoints < match.awayPoints)
				match.awayWin = "bold";

			if (d.round.indexOf("Finals") == 0) {
				if (!imfl.years[imfl.currentYear].finals[d.round]) {
					imfl.years[imfl.currentYear].finals[d.round] = { 
						name: d.round, 
						matches: [],
					};
				}
				imfl.years[imfl.currentYear].finals[d.round].matches.push(match);
			}
			else {
				if (!imfl.years[imfl.currentYear].rounds[d.round]) {
					imfl.years[imfl.currentYear].rounds[d.round] = { 
						name: d.round, 
						matches: [],
					};
				}
				imfl.years[imfl.currentYear].rounds[d.round].matches.push(match);
			}

		});
	}
	console.log(imfl.currentYear, "rounds", imfl.years[imfl.currentYear].rounds);
	console.log(imfl.currentYear, "finals", imfl.years[imfl.currentYear].finals);

	if (imfl.roundsVue) {
		imfl.roundsVue.rounds = imfl.years[imfl.currentYear].rounds;
	}	else {
		imfl.roundsVue = new Vue({
			el: "#roundsDiv",
			data: {rounds: imfl.years[imfl.currentYear].rounds},
			methods: { 
				filteredRounds: function() {
					var newRounds = {};
					var myRounds = this.rounds;
					Object.keys(this.rounds).forEach(function(key) {
						newRounds[key] = { 
							name: myRounds[key].name, 
							matches: myRounds[key].matches.filter(function(m) {
							if(!imfl.fitz) {
								if (m.homeTeam == "Fitzroy" || m.awayTeam == "Fitzroy")
									return false;
							}
							if(!imfl.south) {
								if (m.homeTeam == "South Melbourne" || m.awayTeam == "South Melbourne")
									return false;
							}
							return true;
						})
						} 
					});
					return newRounds;
				}
			}
		});
	}

	if (imfl.finalsVue) {
		imfl.finalsVue.rounds = imfl.years[imfl.currentYear].rounds;
	}	else {
		imfl.finalsVue = new Vue({
			el: "#finalsDiv",
			data: {finals: imfl.years[imfl.currentYear].finals},
			methods: { 
				filteredFinals: function() {
					var newFinals = {};
					var myFinals = this.finals;
					Object.keys(this.finals).forEach(function(key) {
						newFinals[key] = { 
							name: myFinals[key].name, 
							matches: myFinals[key].matches.filter(function(m) {
							if(!imfl.fitz) {
								if (m.homeTeam == "Fitzroy" || m.awayTeam == "Fitzroy")
									return false;
							}
							if(!imfl.south) {
								if (m.homeTeam == "South Melbourne" || m.awayTeam == "South Melbourne")
									return false;
							}
							return true;
						})
						} 
					});
					return newFinals;
				}
			}
		});
	}

};

var fetchData = function() {
	console.log("now in: fetchData");
	console.log("selected year:", imfl.currentYear);

	if (imfl.years[imfl.currentYear]) {
		loadSeason();
	}

	var urlBase = "https://imfl.neocities.org/yeardata/";
	
	Papa.parse(urlBase + imfl.currentYear + ".csv", {
		download: true,
		header: true,
		dynamicTyping: true,
		complete: function(results) {
			loadSeason(results);
		},
		error: function() {
			console.log("assume the season hasn't started for this year yet. Maybe one day I'll put a fixture");
			yearSelect.options.remove(0);
			imfl.currentYear = document.getElementById("yearSelect").value;
			window.location.hash = imfl.currentYear;
			Papa.parse(urlBase + imfl.currentYear + ".csv", {
				download: true,
				header: true,
				dynamicTyping: true,
				complete: function(results) {
					loadSeason(results);
				},
				error: function() {
					console.log("second error, bailing out");
				}
			});
		}
	});

};


var onTraitorChange = function() {
	console.log("onTraitorChange", this.id, this.checked);
	imfl[this.id] = this.checked;
	localStorage.setItem(this.id, this.checked ? "checked" : "");
	imfl.roundsVue.$forceUpdate();
	// imfl.finalsVue.$forceUpdate();
	// imfl.ladderVue.$forceUpdate();
}

// start here

// first we use local storage to see if we want fitz and south
var traitors = ["fitz", "south"];
traitors.forEach(function(team) {
	var ls = localStorage.getItem(team);
	if (ls != null) {
			document.getElementById(team).checked = imfl[team] = (ls == "checked");
	} 
	else {
		localStorage.setItem(team, "checked"); // set a default value
		imfl[team] = true;
	}
});

document.getElementById("fitz").addEventListener("change", onTraitorChange);
document.getElementById("south").addEventListener("change", onTraitorChange);

// second populate the year select box
imfl.currentYear = new Date().getFullYear();
var years = [];
for(var i = imfl.currentYear; i >= 1982; --i)
	years.push(String(i));
var hashYear = window.location.hash;
if (hashYear) {
	hashYear = hashYear.substring(1);
	if (years.indexOf(hashYear) >= 0) {
		imfl.currentYear = hashYear;
	} 
	else {
		imfl.currentYear = new Date().getFullYear();
		window.location.hash = imfl.currentYear;
	}
} 
var yearsVue = new Vue({
	el: "#yearSelect",
	data: {
		years: years,
		currentYear: imfl.currentYear
	},
	mounted: fetchData
});

document.getElementById("yearSelect").addEventListener("change", function() {
	imfl.currentYear = this.value;
	window.location.hash = imfl.currentYear;
	fetchData();
});




/*

		function loadSeason()
		{
				var select = document.getElementById("yearSelect");
				var season = select.options[select.selectedIndex].value;
				var seasonData = seasons[season];
				var ladder = {};
				var ladderDone = false;

				var div = document.getElementById("seasonDetails");
				div.innerHTML = "";
				
				var includeSouth = document.getElementById("south").checked;
				var includeFitzroy = document.getElementById("fitzroy").checked;

				for (var round in seasonData)
				{
						if (round.indexOf("F") >= 0 && !ladderDone)
						{
								div.innerHTML += doLadder(ladder);
								ladderDone = true;
						}

						div.innerHTML += "<h2>" + round + "</h2>";
						for (var i = 0; i < seasonData[round].length; ++i)
						{
								var match = seasonData[round][i];
								
								if (!includeSouth && (match.homeTeam == "South Melbourne" || match.awayTeam == "South Melbourne"))
									continue;
								if (!includeFitzroy && (match.homeTeam == "Fitzroy" || match.awayTeam == "Fitzroy"))
									continue;
								
								var homeTeamPoints = parseInt((match.homeGoals * 6) + match.homeBehinds);
								var awayTeamPoints = parseInt((match.awayGoals * 6) + match.awayBehinds);

								div.innerHTML += "<span>";
								if (homeTeamPoints >= awayTeamPoints)
										div.innerHTML += "<strong>" + match.homeTeam + " " + match.homeGoals + "." + match.homeBehinds + "." + homeTeamPoints + "</strong>";
								else
										div.innerHTML += match.homeTeam + " " + match.homeGoals + "." + match.homeBehinds + "." + homeTeamPoints;

								div.innerHTML += " vs ";

								if (homeTeamPoints <= awayTeamPoints)
										div.innerHTML += "<strong>" + match.awayTeam + " " + match.awayGoals + "." + match.awayBehinds + "." + awayTeamPoints + "</strong>";
								else
										div.innerHTML += match.awayTeam + " " + match.awayGoals + "." + match.awayBehinds + "." + awayTeamPoints;

								div.innerHTML += "<br>"

								// now add result to ladder
								if (!ladder[match.homeTeam])
										ladder[match.homeTeam] = { wins: 0, losses: 0, draws: 0, pfor: 0, against: 0, points: 0, percentage: 0 };
								if (!ladder[match.awayTeam])
										ladder[match.awayTeam] = { wins: 0, losses: 0, draws: 0, pfor: 0, against: 0, points: 0, percentage: 0 };

								if (homeTeamPoints > awayTeamPoints)
								{
										ladder[match.homeTeam].wins += 1;
										ladder[match.homeTeam].points += 4
										ladder[match.awayTeam].losses += 1;
								}
								else if (homeTeamPoints == awayTeamPoints)
								{
										ladder[match.homeTeam].draws += 1;
										ladder[match.homeTeam].points += 2
										ladder[match.awayTeam].draws += 1;
										ladder[match.awayTeam].points += 2
								}
								else if (homeTeamPoints < awayTeamPoints)
								{
										ladder[match.homeTeam].losses += 1;
										ladder[match.awayTeam].wins += 1;
										ladder[match.awayTeam].points += 4
								}
								ladder[match.homeTeam].pfor += homeTeamPoints;
								ladder[match.homeTeam].against += awayTeamPoints;
								ladder[match.awayTeam].pfor += awayTeamPoints;
								ladder[match.awayTeam].against += homeTeamPoints;
								ladder[match.homeTeam].percentage = ladder[match.homeTeam].pfor / ladder[match.homeTeam].against * 100;
								ladder[match.awayTeam].percentage = ladder[match.awayTeam].pfor / ladder[match.awayTeam].against * 100;

						}
				}
				if (!ladderDone)
					div.innerHTML += doLadder(ladder);
		}

		function doLadder(ladder)
		{
				var ret = "<h2>Ladder</h2>";
				// sort teams
				var sortedLadder = [];
				for (var team in ladder)
				{
						sortedLadder.push({ name: team, data: ladder[team] });
				}
				sortedLadder.sort(sorter);

				// write ladder
				ret += "<table><tr><th></th><th>W</th><th>L</th><th>D</th><th>F</th><th>A</th><th>%</th><th>Pts</th></tr>";
				for (var i = 0; i < sortedLadder.length; ++i)
				{
						var team = sortedLadder[i];
						var tr = "<tr>";
						if (i == 4)
								tr = "<tr class=borderBottom>"

						ret += tr + "<td class=name>" + team.name + "</td><td>" + team.data.wins + "</td><td>" + team.data.losses + "</td><td>" + team.data.draws + "</td><td>" + team.data.pfor + "</td><td>" + team.data.against + "</td><td>" + team.data.percentage.toFixed(1) + "</td><td>" + team.data.points + "</td></tr>";
				}
				ret += "</table>";
				return ret;
		}


		function sorter(a, b)
		{
				if (a.data.points < b.data.points)
						return 1;
				if (a.data.points > b.data.points)
						return -1;
				if (a.data.points == b.data.points)
				{
						if (a.data.percentage < b.data.percentage)
								return 1;
						if (a.data.percentage > b.data.percentage)
								return -1;
				}
				return 0;
		}

		function loadSeasons(text)
		{
				var seasonData = text.split("\n");
				var i;
				for (i = 0; i < seasonData.length; ++i)
				{
						if (!seasonData[i])
							break;
						var matchData = seasonData[i].split(",");
						var year = matchData[0];
						var roundNumber = matchData[1];
						var homeTeam = verifyTeam(matchData[2]);
						var homeGoals = matchData[3];
						var homeBehinds = matchData[4];
						var awayTeam = matchData[5];
						var awayGoals = matchData[6];
						var awayBehinds = matchData[7];

						// create the season if it doesn't exist
						if (!seasons[year])
						{
								seasons[year] = {};
								document.getElementById("yearSelect").add(new Option(year, year), 0);
						}
						var season = seasons[year];
						// create the round if it doesn't exist
						if (!season[roundNumber])
								season[roundNumber] = [];
						var round = season[roundNumber];
						// add the match
						round.push({
								homeTeam: homeTeam,
								homeGoals: parseInt(homeGoals),
								homeBehinds: parseInt(homeBehinds),
								awayTeam: awayTeam,
								awayGoals: parseInt(awayGoals),
								awayBehinds: parseInt(awayBehinds)
						});
				}
		}

		function verifyTeam(teamName)
		{
				for (var i = 0; i < teams.length; ++i)
						if (teams[i] == teamName)
								return teamName;

				throw new Error("incorrect team Name found: " + teamName);
		}
		
		document.getElementById("south").onchange = function() {
			loadSeason();
		};
		document.getElementById("fitzroy").onchange = function() {
			loadSeason();
		};
*/

</script>
</body>
</html>
